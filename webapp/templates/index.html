<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dự đoán Bệnh Tim - Heart Disease Prediction</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: #2196F3;
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .content {
            padding: 40px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 0.95em;
        }
        
        .form-group input,
        .form-group select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }
        
        .form-group small {
            margin-top: 5px;
            color: #666;
            font-size: 0.85em;
        }
        
        .form-group .error-message {
            margin-top: 5px;
            color: #d32f2f;
            font-size: 0.85em;
            display: none;
        }
        
        .form-group .error-message.show {
            display: block;
        }
        
        .form-group.has-error input,
        .form-group.has-error select {
            border-color: #d32f2f;
            background-color: #ffebee;
        }
        
        .btn-predict {
            width: 100%;
            padding: 15px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-predict:hover {
            background: #1976D2;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .btn-predict:active {
            transform: translateY(0);
        }
        
        .result {
            margin-top: 30px;
            padding: 30px;
            border-radius: 15px;
            display: none;
        }
        
        .result.show {
            display: block;
            animation: slideIn 0.5s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .result.positive {
            background: #fff3e0;
            color: #e65100;
            border: 2px solid #ff9800;
        }
        
        .result.negative {
            background: #e8f5e9;
            color: #2e7d32;
            border: 2px solid #66bb6a;
        }
        
        .result h2 {
            font-size: 2em;
            margin-bottom: 15px;
        }
        
        .result-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .result-item {
            background: rgba(255,255,255,0.6);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(0,0,0,0.1);
        }
        
        .result-item h3 {
            font-size: 0.9em;
            margin-bottom: 5px;
            opacity: 0.7;
            font-weight: 600;
        }
        
        .result-item p {
            font-size: 1.5em;
            font-weight: 600;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2196F3;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
            border-left: 4px solid #ef5350;
            animation: shake 0.5s;
        }
        
        .error.show {
            display: block;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        input:invalid, select:invalid {
            border-color: #ef5350;
        }
        
        input:valid:not(:placeholder-shown), select:valid:not([value=""]) {
            border-color: #4caf50;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>Dự đoán Bệnh Tim</h1>
        <p>Hệ thống dự đoán nguy cơ bệnh tim với Logistic Regression</p>
    </div>

    <div class="content">
        <form id="predictionForm">
            <div class="form-grid">
                <div class="form-group" id="group-age_years">
                    <label for="age_years">Tuổi (Age) *</label>
                    <input type="text" id="age_years" name="age_years" placeholder="Ví dụ: 50">
                    <small>Tuổi của bệnh nhân (0-100 tuổi)</small>
                    <div class="error-message" id="error-age_years"></div>
                </div>

                <div class="form-group" id="group-gender">
                    <label for="gender">Giới tính (Gender) *</label>
                    <select id="gender" name="gender">
                        <option value="">-- Chọn giới tính --</option>
                        <option value="1">Nữ</option>
                        <option value="2">Nam</option>
                    </select>
                    <small>1: Nữ, 2: Nam</small>
                    <div class="error-message" id="error-gender"></div>
                </div>

                <div class="form-group" id="group-height">
                    <label for="height">Chiều cao (Height) *</label>
                    <input type="text" id="height" name="height" placeholder="Ví dụ: 165">
                    <small>Chiều cao (100-250 cm)</small>
                    <div class="error-message" id="error-height"></div>
                </div>

                <div class="form-group" id="group-weight">
                    <label for="weight">Cân nặng (Weight) *</label>
                    <input type="text" id="weight" name="weight" placeholder="Ví dụ: 70">
                    <small>Cân nặng (30-200 kg)</small>
                    <div class="error-message" id="error-weight"></div>
                </div>

                <div class="form-group" id="group-ap_hi">
                    <label for="ap_hi">Huyết áp tâm thu (Systolic) *</label>
                    <input type="text" id="ap_hi" name="ap_hi" placeholder="Ví dụ: 120">
                    <small>Huyết áp tâm thu (80-250 mmHg)</small>
                    <div class="error-message" id="error-ap_hi"></div>
                </div>

                <div class="form-group" id="group-ap_lo">
                    <label for="ap_lo">Huyết áp tâm trương (Diastolic) *</label>
                    <input type="text" id="ap_lo" name="ap_lo" placeholder="Ví dụ: 80">
                    <small>Huyết áp tâm trương (40-150 mmHg)</small>
                    <div class="error-message" id="error-ap_lo"></div>
                </div>

                <div class="form-group" id="group-cholesterol">
                    <label for="cholesterol">Cholesterol *</label>
                    <select id="cholesterol" name="cholesterol">
                        <option value="">-- Chọn --</option>
                        <option value="1">Bình thường</option>
                        <option value="2">Cao hơn bình thường</option>
                        <option value="3">Rất cao</option>
                    </select>
                    <small>Mức cholesterol</small>
                    <div class="error-message" id="error-cholesterol"></div>
                </div>

                <div class="form-group" id="group-gluc">
                    <label for="gluc">Đường huyết *</label>
                    <select id="gluc" name="gluc">
                        <option value="">-- Chọn --</option>
                        <option value="1">Bình thường</option>
                        <option value="2">Cao hơn bình thường</option>
                        <option value="3">Rất cao</option>
                    </select>
                    <small>Mức đường huyết (Glucose)</small>
                    <div class="error-message" id="error-gluc"></div>
                </div>

                <div class="form-group" id="group-smoke">
                    <label for="smoke">Hút thuốc *</label>
                    <select id="smoke" name="smoke">
                        <option value="">-- Chọn --</option>
                        <option value="0">Không</option>
                        <option value="1">Có</option>
                    </select>
                    <small>Có hút thuốc không?</small>
                    <div class="error-message" id="error-smoke"></div>
                </div>

                <div class="form-group" id="group-alco">
                    <label for="alco">Uống rượu *</label>
                    <select id="alco" name="alco">
                        <option value="">-- Chọn --</option>
                        <option value="0">Không</option>
                        <option value="1">Có</option>
                    </select>
                    <small>Có uống rượu không?</small>
                    <div class="error-message" id="error-alco"></div>
                </div>

                <div class="form-group" id="group-active">
                    <label for="active">Hoạt động thể chất *</label>
                    <select id="active" name="active">
                        <option value="">-- Chọn --</option>
                        <option value="0">Không</option>
                        <option value="1">Có</option>
                    </select>
                    <small>Có hoạt động thể chất không?</small>
                    <div class="error-message" id="error-active"></div>
                </div>
            </div>

            <button type="submit" class="btn-predict">Dự đoán ngay</button>
        </form>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="margin-top: 15px;">Đang phân tích...</p>
        </div>

        <div class="error" id="error"></div>

        <div class="result" id="result">
            <h2 id="resultTitle"></h2>
            <p id="resultMessage"></p>
            <div style="background: rgba(255,255,255,0.8); padding: 15px; border-radius: 10px; margin: 15px 0; border-left: 4px solid currentColor;">
                <h3 style="margin: 0 0 10px 0; font-size: 1em;">Giải thích:</h3>
                <p id="explanation" style="margin: 0; line-height: 1.6;"></p>
            </div>
            <div class="result-details">
                <div class="result-item">
                    <h3>Xác suất có bệnh</h3>
                    <p id="probDisease"></p>
                </div>
                <div class="result-item">
                    <h3>Xác suất không bệnh</h3>
                    <p id="probNoDisease"></p>
                </div>
                <div class="result-item">
                    <h3>Độ tin cậy</h3>
                    <p id="confidence"></p>
                </div>
                <div class="result-item">
                    <h3>Mức độ rủi ro</h3>
                    <p id="riskLevel"></p>
                </div>
                <div class="result-item">
                    <h3>BMI</h3>
                    <p id="bmi"></p>
                </div>
                <div class="result-item">
                    <h3>Pulse Pressure</h3>
                    <p id="pulsePressure"></p>
                </div>
                <div class="result-item">
                    <h3>Risk Score</h3>
                    <p id="riskScore"></p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function clearAllErrors() {
        document.querySelectorAll('.form-group').forEach(group => {
            group.classList.remove('has-error');
        });
        document.querySelectorAll('.error-message').forEach(msg => {
            msg.classList.remove('show');
            msg.textContent = '';
        });
        document.getElementById('error').classList.remove('show');
    }

    function showFieldError(fieldName, message) {
        const errorDiv = document.getElementById('error-' + fieldName);
        const groupDiv = document.getElementById('group-' + fieldName);

        if (errorDiv && groupDiv) {
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
            groupDiv.classList.add('has-error');

            // Scroll to first error
            groupDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    function validateForm() {
        // Get values
        const age_years = document.getElementById('age_years').value.trim();
        const gender = document.getElementById('gender').value;
        const height = document.getElementById('height').value.trim();
        const weight = document.getElementById('weight').value.trim();
        const ap_hi = document.getElementById('ap_hi').value.trim();
        const ap_lo = document.getElementById('ap_lo').value.trim();
        const cholesterol = document.getElementById('cholesterol').value;
        const gluc = document.getElementById('gluc').value;
        const smoke = document.getElementById('smoke').value;
        const alco = document.getElementById('alco').value;
        const active = document.getElementById('active').value;

        // Check empty
        if (!age_years) return { field: 'age_years', message: 'Vui lòng nhập tuổi' };
        if (!gender) return { field: 'gender', message: 'Vui lòng chọn giới tính' };
        if (!height) return { field: 'height', message: 'Vui lòng nhập chiều cao' };
        if (!weight) return { field: 'weight', message: 'Vui lòng nhập cân nặng' };
        if (!ap_hi) return { field: 'ap_hi', message: 'Vui lòng nhập huyết áp tâm thu' };
        if (!ap_lo) return { field: 'ap_lo', message: 'Vui lòng nhập huyết áp tâm trương' };
        if (!cholesterol) return { field: 'cholesterol', message: 'Vui lòng chọn mức cholesterol' };
        if (!gluc) return { field: 'gluc', message: 'Vui lòng chọn mức đường huyết' };
        if (!smoke) return { field: 'smoke', message: 'Vui lòng chọn có hút thuốc hay không' };
        if (!alco) return { field: 'alco', message: 'Vui lòng chọn có uống rượu hay không' };
        if (!active) return { field: 'active', message: 'Vui lòng chọn có hoạt động thể chất hay không' };

        // Check if number
        const age_num = parseFloat(age_years);
        if (isNaN(age_num)) return { field: 'age_years', message: 'Tuổi phải là số' };

        const height_num = parseFloat(height);
        if (isNaN(height_num)) return { field: 'height', message: 'Chiều cao phải là số' };

        const weight_num = parseFloat(weight);
        if (isNaN(weight_num)) return { field: 'weight', message: 'Cân nặng phải là số' };

        const ap_hi_num = parseFloat(ap_hi);
        if (isNaN(ap_hi_num)) return { field: 'ap_hi', message: 'Huyết áp tâm thu phải là số' };

        const ap_lo_num = parseFloat(ap_lo);
        if (isNaN(ap_lo_num)) return { field: 'ap_lo', message: 'Huyết áp tâm trương phải là số' };

        // Check ranges
        if (age_num < 0 || age_num > 100) return { field: 'age_years', message: 'Tuổi phải từ 0 đến 100' };
        if (height_num < 100 || height_num > 250) return { field: 'height', message: 'Chiều cao phải từ 100 đến 250 cm' };
        if (weight_num < 30 || weight_num > 200) return { field: 'weight', message: 'Cân nặng phải từ 30 đến 200 kg' };
        if (ap_hi_num < 80 || ap_hi_num > 250) return { field: 'ap_hi', message: 'Huyết áp tâm thu phải từ 80 đến 250 mmHg' };
        if (ap_lo_num < 40 || ap_lo_num > 150) return { field: 'ap_lo', message: 'Huyết áp tâm trương phải từ 40 đến 150 mmHg' };
        if (ap_lo_num >= ap_hi_num) return { field: 'ap_lo', message: 'Huyết áp tâm trương phải nhỏ hơn huyết áp tâm thu' };

        // Check BMI
        const bmi = weight_num / Math.pow(height_num / 100, 2);
        if (bmi < 10 || bmi > 60) return { field: 'weight', message: 'Tỷ lệ chiều cao/cân nặng không hợp lý (BMI phải từ 10-60)' };

        return null; // No error
    }

    document.getElementById('predictionForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        // Clear previous errors and results
        clearAllErrors();
        document.getElementById('result').classList.remove('show');

        // Validate form
        const validationError = validateForm();
        if (validationError) {
            showFieldError(validationError.field, validationError.message);
            return;
        }

        // Collect form data
        const data = {
            age_years: parseFloat(document.getElementById('age_years').value),
            gender: parseFloat(document.getElementById('gender').value),
            height: parseFloat(document.getElementById('height').value),
            weight: parseFloat(document.getElementById('weight').value),
            ap_hi: parseFloat(document.getElementById('ap_hi').value),
            ap_lo: parseFloat(document.getElementById('ap_lo').value),
            cholesterol: parseFloat(document.getElementById('cholesterol').value),
            gluc: parseFloat(document.getElementById('gluc').value),
            smoke: parseFloat(document.getElementById('smoke').value),
            alco: parseFloat(document.getElementById('alco').value),
            active: parseFloat(document.getElementById('active').value)
        }

        // Show loading
        document.getElementById('loading').classList.add('show');

        try {
            // Send prediction request
            const response = await fetch('/predict', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            // Hide loading
            document.getElementById('loading').classList.remove('show');

            if (response.ok) {
                // Show result
                const resultDiv = document.getElementById('result');
                resultDiv.classList.remove('positive', 'negative');
                resultDiv.classList.add(result.prediction === 1 ? 'positive' : 'negative');

                document.getElementById('resultTitle').textContent = result.prediction_label;
                document.getElementById('resultMessage').textContent =
                    result.prediction === 1
                    ? 'Kết quả cho thấy có nguy cơ mắc bệnh tim. Vui lòng tham khảo ý kiến bác sĩ.'
                    : 'Kết quả cho thấy nguy cơ thấp. Hãy duy trì lối sống lành mạnh!';

                document.getElementById('probDisease').textContent =
                    (result.probability.has_disease * 100).toFixed(1) + '%';
                document.getElementById('probNoDisease').textContent =
                    (result.probability.no_disease * 100).toFixed(1) + '%';
                document.getElementById('confidence').textContent =
                    result.confidence.toFixed(1) + '%';
                document.getElementById('riskLevel').textContent = result.risk_level;
                document.getElementById('bmi').textContent = result.bmi;
                document.getElementById('pulsePressure').textContent = result.pulse_pressure + ' mmHg';
                document.getElementById('riskScore').textContent = result.risk_score;
                document.getElementById('explanation').textContent = result.explanation;

                resultDiv.classList.add('show');

                // Scroll to result
                resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } else {
                throw new Error(result.error || 'Có lỗi xảy ra');
            }
        } catch (error) {
            // Hide loading
            document.getElementById('loading').classList.remove('show');

            // Show error
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = 'Lỗi: ' + error.message;
            errorDiv.classList.add('show');
        }
    });

    // Real-time BMI calculation
    document.getElementById('height').addEventListener('input', showBMI);
    document.getElementById('weight').addEventListener('input', showBMI);

    function showBMI() {
        const height = parseFloat(document.getElementById('height').value);
        const weight = parseFloat(document.getElementById('weight').value);

        if (height && weight && height > 0 && !isNaN(height) && !isNaN(weight)) {
            const bmi = weight / Math.pow(height / 100, 2);
            if (bmi >= 10 && bmi <= 60) {
                const heightSmall = document.querySelector('#height + small');
                heightSmall.textContent = `Chiều cao (100-250 cm) - BMI dự kiến: ${bmi.toFixed(1)}`;
            }
        }
    }

    // Clear error when user starts typing/selecting
    document.querySelectorAll('input, select').forEach(element => {
        element.addEventListener('input', function() {
            const fieldName = this.id;
            const errorDiv = document.getElementById('error-' + fieldName);
            const groupDiv = document.getElementById('group-' + fieldName);

            if (errorDiv && groupDiv) {
                errorDiv.classList.remove('show');
                groupDiv.classList.remove('has-error');
            }
        });
    });
</script>
</body>
</html>
